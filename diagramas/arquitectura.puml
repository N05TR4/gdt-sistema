@startuml Arquitectura_Capas_GDT
!theme plain
title Arquitectura en Capas - Sistema GDT

package "Capa de Presentación" {
  [DeclaracionesController] as Controller
  [Middleware Pipeline] as Middleware
}

package "Capa de Aplicación" {
  [DeclaracionesService] as AppService
  [DTOs] as DTOs
  interface "IDeclaracionRepository" as IRepo
}

package "Capa de Dominio" {
  [Declaracion Entity] as Entity
  [TipoImpuesto Enum] as EnumTipo
  [EstadoDeclaracion Enum] as EnumEstado
  [Business Rules] as Rules
}

package "Capa de Infraestructura" {
  [DeclaracionRepository] as Repo
  [GdtDbContext] as DbContext
  database "SQL Server" as DB
}

package "Aspectos Transversales" {
  [Logging] as Log
  [Exception Handling] as ExHandler
  [Validation] as Valid
}

Controller --> AppService : usa
Controller --> DTOs : mapea
AppService --> IRepo : depende
AppService --> Entity : manipula
Entity --> Rules : aplica
Entity --> EnumTipo : usa
Entity --> EnumEstado : usa

Repo --> DbContext : usa
DbContext --> DB : ORM

AppService --> Log : registra
AppService --> ExHandler : maneja errores
AppService --> Valid : valida DTOs

Middleware --> Controller : invoca
Middleware --> ExHandler : captura errores

note top of "Capa de Presentación"
  Maneja HTTP, rutas, autenticación
  y mapea requests a DTOs/controladores.
end note

note top of "Capa de Aplicación"
  Orquesta casos de uso, coordina
  entre Presentación y Dominio.
end note

note top of "Capa de Dominio"
  Reglas de negocio puras, independientes
  de infraestructura y frameworks.
end note

note top of "Capa de Infraestructura"
  Implementaciones técnicas:
  repositorios, ORM, base de datos.
end note

note right of Entity
  Entidad de dominio rica:
  - Encapsula lógica
  - Valida estados
  - Calcula impuestos
end note

note right of DTOs
  Objetos de transferencia:
  - DeclaracionCreateDto
  - DeclaracionDetailDto
end note

note bottom of IRepo
  Contrato de acceso a datos:
  + Add(Declaracion)
  + GetById(id)
  + GetByPeriodo(rnc, periodo)
end note

@enduml


@startuml Microservicios_GDT
!theme plain
title Arquitectura de Microservicios - Sistema GDT

actor "Cliente Web/Móvil" as Client

cloud "API Gateway" {
  [YARP Gateway] as Gateway
  [Rate Limiting] as RateLimit
  [Authentication] as Auth
}

package "Identity Service" {
  [Auth API] as AuthAPI
  database "Identity DB" as IdentityDB
}

package "Declaraciones Service" {
  [Declaraciones API] as DeclAPI
  database "Declaraciones DB" as DeclDB
}

package "Cálculos Service" {
  [Calculos API] as CalcAPI
}

package "Validaciones Service" {
  [Validaciones API] as ValidAPI
  database "Cache Distribuida" as Cache
}

package "Notificaciones Service" {
  [Notificaciones API] as NotifAPI
  [Email Sender] as Email
  [SMS Sender] as SMS
}

queue "Azure Service Bus" as Bus {
  [Topic: DeclaracionCreada]
  [Topic: DeclaracionValidada]
  [Topic: CalculosCompletados]
}

cloud "Observabilidad" {
  [Azure App Insights] as Insights
  [Logs Centralizados] as Logs
  [Distributed Tracing] as Trace
}

Client --> Gateway : HTTP
Gateway --> AuthAPI : /api/auth/*
Gateway --> DeclAPI : /api/declaraciones/*
Gateway --> CalcAPI : /api/calculos/*
Gateway --> ValidAPI : /api/validaciones/*
Gateway --> NotifAPI : /api/notificaciones/*

AuthAPI --> IdentityDB
DeclAPI --> DeclDB
ValidAPI --> Cache

DeclAPI --> Bus : publish DeclaracionCreada
Bus --> ValidAPI : event DeclaracionCreada
ValidAPI --> Bus : publish DeclaracionValidada
Bus --> CalcAPI : event DeclaracionValidada
CalcAPI --> Bus : publish CalculosCompletados
Bus --> DeclAPI : event CalculosCompletados
Bus --> Noti
